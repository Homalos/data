# SimNow合约获取指南

## 概述

本脚本用于从SimNow模拟环境获取真实的期货合约列表，并保存为JSON格式。

## 前提条件

### 1. 注册SimNow账号

访问 http://www.simnow.com.cn/ 注册账号：
- 注册后会获得用户ID和密码
- SimNow提供7x24小时模拟环境
- 完全免费，无需实盘账号

### 2. 配置账号信息

**方式1: 使用环境变量（推荐）**

在 `.env` 文件中配置：
```bash
CTP_USER_ID=你的SimNow账号
CTP_PASSWORD=你的SimNow密码
```

**方式2: 使用配置文件**

在 `config/config_md.yaml` 中配置：
```yaml
BrokerID: "9999"
TdFrontAddress: tcp://180.168.146.187:10130  # SimNow 7x24交易前置
MdFrontAddress: tcp://180.168.146.187:10131  # SimNow 7x24行情前置
```

## 使用方法

### 方式1: 使用快捷脚本（推荐）

```bash
start_update_instruments.bat
```

### 方式2: 直接运行Python脚本

```bash
python scripts/update_instruments.py
```

脚本会：
1. 自动从配置文件读取经纪商ID和前置地址
2. 从环境变量或提示输入读取账号密码
3. 连接SimNow并获取合约列表
4. 保存到 `data/instruments.json`

## 执行流程

脚本会自动完成以下步骤：

1. **连接SimNow交易前置**
   
   ```
   正在连接到SimNow...
   ✅ 连接到SimNow交易前置成功
```
   
2. **登录**
   ```
   发送登录请求...
   ✅ 登录成功
   交易日: 20251226
   ```

3. **查询合约**
   ```
   开始查询合约信息...
   已获取 100 个合约...
   已获取 200 个合约...
   ...
   ✅ 合约查询完成，共获取 XXX 个期货合约
   ```

4. **保存结果**
   ```
   输出文件: data/instruments_simnow.json
   合约总数: XXX
   
   按交易所统计:
     CFFEX: XX 个
     CZCE: XX 个
     DCE: XX 个
     SHFE: XX 个
     INE: XX 个
   ```

## 输出格式

### 文件位置
```
data/instruments_simnow.json
```

### JSON结构

```json
{
  "update_time": "2025-12-26T14:30:00.123456",
  "total_count": 500,
  "instruments": [
    {
      "instrument_id": "ag2501",
      "exchange_id": "SHFE",
      "instrument_name": "白银2501",
      "product_id": "ag",
      "product_class": 1,
      "delivery_year": 2025,
      "delivery_month": 1,
      "volume_multiple": 15,
      "price_tick": 1.0,
      "create_date": "20231201",
      "open_date": "20231201",
      "expire_date": "20250115",
      "is_trading": 1
    },
    ...
  ]
}
```

### 字段说明

| 字段 | 说明 | 示例 |
|------|------|------|
| instrument_id | 合约代码 | ag2501 |
| exchange_id | 交易所 | SHFE |
| instrument_name | 合约名称 | 白银2501 |
| product_id | 品种代码 | ag |
| volume_multiple | 合约乘数 | 15 |
| price_tick | 最小变动价位 | 1.0 |
| is_trading | 是否可交易 | 1 |

## SimNow环境说明

### 可用环境

| 环境 | 前置地址 | 特点 |
|------|----------|------|
| 7x24 | tcp://182.254.243.31:40001 (交易)<br>tcp://182.254.243.31:40011 (行情) | 交易日16:00～次日09:00<br/>非交易日16:00～次日12:00 |
| 第一组 | tcp://182.254.243.31:30001 (交易)<br>tcp://182.254.243.31:30012 (行情) | 与实盘交易时间保持一致 |
| 第二组 | tcp://182.254.243.31:30002 (交易)<br>tcp://182.254.243.31:30012 (行情) | 与实盘交易时间保持一致 |
| 第三组 | tcp://182.254.243.31:30003 (交易)<br/>tcp://182.254.243.31:30013 (行情) | 与实盘交易时间保持一致 |

### 切换环境

修改配置文件中的 `TdFrontAddress`：

```yaml
# config/config_td.yaml

# 使用7x24环境
TdFrontAddress: tcp://182.254.243.31:40001

# 或使用第一组环境
TdFrontAddress: tcp://182.254.243.31:30001
```

## 常见问题

### 1. 连接超时

**问题**: 等待60秒后仍未连接成功

**解决**:
- 检查网络连接
- 尝试切换到其他SimNow环境
- 检查防火墙设置

### 2. 登录失败

**问题**: 登录失败，错误码3

**解决**:
- 检查用户ID和密码是否正确
- 确认SimNow账号已激活
- 尝试在SimNow官网登录验证

### 3. 查询合约失败

**问题**: 查询合约返回错误

**解决**:
- 确认已成功登录
- 检查网络连接是否稳定
- 重新运行脚本

### 4. 获取的合约数量少

**问题**: 只获取到很少的合约

**解决**:
- 脚本只获取期货合约（不包括期权）
- 这是正常的，SimNow环境的合约数量可能少于生产环境
- 检查 `is_trading` 字段，可能部分合约已停止交易

## 定期更新

推荐开盘前更新

## 与生产环境对比

| 项目 | SimNow | 生产环境 |
|------|--------|----------|
| 合约数量 | 较少 | 完整 |
| 数据真实性 | 模拟 | 真实 |
| 可用时间 | 7x24 | 交易时间 |
| 费用 | 免费 | 需开户 |
| 适用场景 | 开发测试 | 实盘交易 |

## 总结

✅ **优点**:
- 自动化获取合约列表
- 支持多个SimNow环境
- 数据格式标准化
- 易于集成到行情服务

📝 **注意**:
- 需要SimNow账号
- 合约数量可能少于生产环境
- 建议定期更新

🎯 **下一步**:
1. 注册SimNow账号
2. 配置账号信息
3. 运行脚本获取合约
4. 启动行情服务测试

---

**文档版本**: 1.0
**更新时间**: 2025-12-30
